suite: test ingress audit
templates:
  - ingress.yaml
tests:
  - it: doc 2
    release:
      namespace: mds
    set:
      tls:
        enabled: true
    asserts:
      - isAPIVersion:
          of: networking.istio.io/v1alpha3
        documentIndex: 2
      - isKind:
          of: VirtualService
        documentIndex: 2
      - equal:
          path: metadata.name
          value: mds-audit-route
        documentIndex: 2
      - equal:
          path: metadata.namespace
          value: mds
        documentIndex: 2
      - isNull:
          path: spec.hosts[0]
        documentIndex: 2
      - equal:
          path: spec.gateways[0]
          value: istio-autogenerated-k8s-ingress.istio-system
        documentIndex: 2
      - equal:
          path: spec.http[0].match[0].uri.prefix
          value: /audit
        documentIndex: 2
      - equal:
          path: spec.http[0].match[0].scheme.exact
          value: https
        documentIndex: 2
      - equal:
          path: spec.http[0].route[0].destination.port.number
          value: 4002
        documentIndex: 2
      - equal:
          path: spec.http[0].route[0].destination.host
          value: mds-audit.mds.svc.cluster.local
        documentIndex: 2
      - equal:
          path: spec.http[0].corsPolicy.allowOrigin[0]
          value: "*"
        documentIndex: 2
      - equal:
          path: spec.http[0].corsPolicy.allowMethods[0]
          value: POST
        documentIndex: 2
      - equal:
          path: spec.http[0].corsPolicy.allowMethods[1]
          value: GET
        documentIndex: 2
      - equal:
          path: spec.http[0].corsPolicy.allowMethods[2]
          value: HEAD
        documentIndex: 2
      - equal:
          path: spec.http[0].corsPolicy.allowMethods[3]
          value: OPTIONS
        documentIndex: 2
      - equal:
          path: spec.http[0].corsPolicy.allowMethods[4]
          value: PATCH
        documentIndex: 2
      - equal:
          path: spec.http[0].corsPolicy.allowMethods[5]
          value: PUT
        documentIndex: 2
      - equal:
          path: spec.http[0].corsPolicy.allowCredentials
          value: false
        documentIndex: 2
      - equal:
          path: spec.http[0].corsPolicy.allowHeaders[0]
          value: Content-Type
        documentIndex: 2
      - equal:
          path: spec.http[0].corsPolicy.allowHeaders[1]
          value: Authorization
        documentIndex: 2
      - equal:
          path: spec.http[0].corsPolicy.maxAge
          value: "10m"
        documentIndex: 2
suite: test deployment agency override
templates:
  - deployment.yaml
tests:
  - it: doc 0
    release:
      namespace: mds
    set:
      registry: my-registry
      apis:
        mds-agency:
          version: 1.2.3
          migration: true
          env:
            - name: env-name
              value: env-value
      resourcesLimitsCpu: 50m
      resourcesLimitsMemory: 51Mi
      resourcesRequestsCpu: 5m
      resourcesRequestsMemory: 12Mi
      timezone: my-timezone
      postgresql.postgresqlUsername: my-postgresql-user-name
      postgresql.postgresqlDatabase: my-postgresql-database
      postgresql.internal: false
      postgresql.host: my-postgresql-host
      postgresql.hostReader: my-postgresql-host-reader
      postgresql.port: 1234
      redis.internal: false
      redis.host: my-redis-host
      redis.port: 5678
      natsNamespace: my-nats
      tenantId: my-tenant
      global:
        env:
          - name: global-env-name
            value: global-env-value
      slack.channel: my-slack-channel
      slack.token: my-slack-token
    asserts:
      - isAPIVersion:
          of: apps/v1
        documentIndex: 0
      - isKind:
          of: Deployment
        documentIndex: 0
      - equal:
          path: metadata.name
          value: mds-agency
        documentIndex: 0
      - equal:
          path: metadata.labels.app
          value: mds-agency
        documentIndex: 0
      - equal:
          path: metadata.namespace
          value: mds
        documentIndex: 0
      - equal:
          path: spec.replicas
          value: 1
        documentIndex: 0
      - equal:
          path: spec.selector.matchLabels.app
          value: mds-agency
        documentIndex: 0
      - equal:
          path: spec.template.metadata.labels.app
          value: mds-agency
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].name
          value: mds-agency
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].image
          value: my-registry/mds-agency:1.2.3
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 50m
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 51Mi
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 5m
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 12Mi
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 4000
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].ports[0].name
          value: user-port
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].ports[0].protocol
          value: TCP
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[0].name
          value: PORT
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[0].value
          value: '4000'
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[1].name
          value: PATH_PREFIX
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[1].value
          value: /agency
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[2].name
          value: TIMEZONE
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[2].value
          value: my-timezone
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[3].name
          value: PG_USER
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[3].value
          value: my-postgresql-user-name
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[4].name
          value: PG_NAME
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[4].value
          value: my-postgresql-database
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[5].name
          value: PG_PASS
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[5].valueFrom.secretKeyRef.name
          value: mds-secrets
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[5].valueFrom.secretKeyRef.key
          value: postgresql-password
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[6].name
          value: PG_HOST
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[6].value
          value: my-postgresql-host
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[7].name
          value: PG_HOST_READER
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[7].value
          value: my-postgresql-host-reader
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[8].name
          value: PG_PORT
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[8].value
          value: '1234'
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[9].name
          value: PG_MIGRATIONS
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[9].value
          value: 'true'
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[10].name
          value: REDIS_HOST
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[10].value
          value: my-redis-host
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[11].name
          value: REDIS_PORT
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[11].value
          value: '5678'
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[12].name
          value: NATS
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[12].value
          value: nats.my-nats.svc.cluster.local
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[13].name
          value: STAN_CLUSTER
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[13].value
          value: nats-streaming
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[14].name
          value: TENANT_ID
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[14].value
          value: my-tenant
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[15].name
          value: SLACK_CHANNEL
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[15].value
          value: my-slack-channel
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[16].name
          value: SLACK_TOKEN
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[16].valueFrom.secretKeyRef.name
          value: mds-secrets
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[16].valueFrom.secretKeyRef.key
          value: slack-token
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[17].name
          value: env-name
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[17].value
          value: env-value
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[18].name
          value: global-env-name
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[18].value
          value: global-env-value
        documentIndex: 0
